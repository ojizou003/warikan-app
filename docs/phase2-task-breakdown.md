# Phase 2 機能拡張 - タスク分解詳細

## 概要

Phase 2では、以下の3つの主要機能を実装します：
1. **履歴機能** - 計算結果の保存と履歴表示
2. **幹事負担パターン** - 幹事が余分に負担する計算パターン
3. **シェア機能** - 結果のクリップボードコピーとURL共有

---

## 1. 履歴機能の実装

### 1.1 基本機能設計

#### データ構造
```javascript
// LocalStorageに保存する履歴データの構造
{
  id: "unique-timestamp-id",
  date: "2024-01-15",
  time: "14:30",
  totalAmount: 5000,
  numberOfPeople: 5,
  calculationType: "equal", // equal, organizer, custom
  perPerson: 1000,
  remainder: 0,
  organizerBurden: 0, // 幹事負担分（該当する場合）
  participants: ["参加者1", "参加者2", ...], // 将来の拡張用
  note: "飲み会会計" // ユーザーメモ（任意）
}
```

#### 実装タスク

**タスク1.1.1: LocalStorageモジュール作成**
- [ ] `src/storage.js` ファイルを作成
- [ ] `saveCalculation(result)` - 計算結果を保存
- [ ] `getHistory(limit = 50)` - 履歴を取得（最大件数指定）
- [ ] `deleteHistoryItem(id)` - 特定の履歴を削除
- [ ] `clearAllHistory()` - 全履歴を削除
- [ ] `exportHistory()` - 履歴データをエクスポート（JSON形式）
- [ ] `importHistory(data)` - 履歴データをインポート

**タスク1.1.2: 履歴表示UIコンポーネント**
- [ ] HTMLに履歴セクションを追加
- [ ] 履歴リスト表示用コンポーネント作成
- [ ] 履歴アイテムのテンプレート作成
- [ ] 無限スクロールまたはページネーション機能
- [ ] 履歴がない場合の空状態表示

**タスク1.1.3: 履歴管理機能**
- [ ] 履歴の削除ボタン（個別削除）
- [ ] 全履歴削除機能（確認ダイアログ付き）
- [ ] 履歴の検索・フィルター機能（日付、金額範囲など）
- [ ] 履歴のソート機能（日付順、金額順など）

### 1.2 UI/UX設計

#### 表示要件
- 履歴は最大50件まで保存
- 1ページに10件ずつ表示（ページネーション）
- 各履歴項目に表示する情報：
  - 日付と時刻
  - 総額と人数
  - 1人あたりの金額
  - 計算タイプ（均等割、幹事負担、カスタム）
  - 備考（あれば）

#### インタラクション
- 履歴項目をクリックで再計算可能
- スワイプで削除（モバイル向け）
- 長押しでメニュー表示（コピー、編集、削除）

---

## 2. 幹事負担パターンの追加

### 2.1 計算ロジック拡張

#### 計算パターン定義
1. **均等割り** - 現行のデフォルト
2. **幹事多め負担** - 幹事が指定額だけ多く支払う
3. **幹事少なめ負担** - 幹事が指定額だけ少なく支払う
4. **幹事固定負担** - 幹事の負担額を固定し、残りを均等割り
5. **参加者別指定** - 各参加者の支払額を個別指定（将来的な拡張）

#### 実装タスク

**タスク2.1.1: 計算エンジン拡張**
- [ ] `performCalculation()` 関数の拡張
- [ ] 新しい計算タイプのパラメータ追加
- [ ] 幹事負担パターンの計算ロジック実装
- [ ] 各パターンのバリデーションルール作成
- [ ] エッジケースの処理（負担額 > 総額など）

**タスク2.1.2: パターン選択UI**
- [ ] 計算タイプ選択用ラジオボタン/セレクトボックス
- [ ] 幹事負担額入力フィールド（動的な表示/非表示）
- [ ] リアルタイムでの計算結果更新
- [ ] パターンごとの入力バリデーション
- [ ] ヘルプテキストと例の表示

### 2.2 具体的な計算例

#### パターン1: 幹事多め負担
- 総額: 10,000円、人数: 4人、幹事負担: +1,000円
- 計算: (10,000 - 1,000) ÷ 4 = 2,250円/人
- 幹事: 2,250 + 1,000 = 3,250円
- 参加者: 2,250円 × 3人 = 6,750円
- 検算: 3,250 + 6,750 = 10,000円

#### パターン2: 幹事固定負担
- 総額: 10,000円、人数: 4人、幹事負担: 3,000円
- 計算: (10,000 - 3,000) ÷ 3 = 2,333円/人
- 幹事: 3,000円（固定）
- 参加者: 2,333円 × 3人 = 6,999円
- 端数: 1円（幹事または参加者で調整）

---

## 3. シェア機能の実装

### 3.1 クリップボードコピー機能

#### コピーする内容
```javascript
// 基本的なテキスト形式
「〇〇会計」
総額: 5,000円
人数: 5人
1人あたり: 1,000円
端数: 0円

【幹事負担の場合】
幹事: 1,500円
参加者: 875円 × 4人 = 3,500円
合計: 5,000円
```

#### 実装タスク

**タスク3.1.1: コピー機能実装**
- [ ] `copyToClipboard(text)` ユーティリティ関数作成
- [ ] 結果表示エリアにコピー追加
- [ ] コピー完了時のフィードバック（トースト通知）
- [ ] フォールバック対応（非モダンブラウザ向け）
- [ ] コピー内容のフォーマット選択（詳細/簡潔）

**タスク3.1.2: シェアボタンUI**
- [ ] 各種シェアボタンの配置
- [ ] コピー、LINE、Twitterなどのアイコン配置
- [ ] ホバー効果とトランジション
- [ ] モバイル向けの最適化

### 3.2 URLパラメータ共有

#### URL構造
```
https://example.com/warikan/?amount=5000&people=5&type=organizer&organizerBurden=500
```

#### 実装タスク

**タスク3.2.1: URL生成機能**
- [ ] `generateShareURL(result)` 関数作成
- [ ] URLパラメータのエンコード/デコード
- [ ] 計算結果をURLに変換
- [ ] 短縮URLオプション（将来的な拡張）

**タスク3.2.2: URLからの復元機能**
- [ ] `loadFromURL()` 関数作成
- [ ] ページ読み込み時のURLパラメータ解析
- [ ] パラメータバリデーション
- [ ] 自動計算実行
- [ ] URL共有専用ページの表示（オプション）

### 3.3 SNS連携

#### シェア先対応
- LINE: `https://social-plugins.line.me/lineit/share?url=`
- Twitter: `https://twitter.com/intent/tweet?text=`
- コピー: クリップボードAPI

#### 実装タスク

**タスク3.3.1: SNSシェア実装**
- [ ] 各SNSのシェアURL生成
- [ ] シェア用テキストの最適化
- [ ] アイコンの配置とスタイリング
- [ ] シェア完了後のフォローアップ

---

## 4. 実装優先順位

### フェーズ2.1: 基本機能（1-2週間）
1. **履歴機能の基本実装**
   - LocalStorageモジュール
   - 履歴表示UI
   - 基本的な履歴管理

2. **幹事負担パターン**
   - 計算エンジン拡張
   - パターン選択UI

### フェーズ2.2: 拡張機能（1週間）
1. **シェア機能**
   - クリップボードコピー
   - URLパラメータ共有

2. **履歴機能拡張**
   - 検索・フィルター機能
   - エクスポート機能

### フェーズ2.3: 仕上げ（数日）
1. **UI/UX改善**
   - アニメーション追加
   - レスポンシブ最適化
   - アクセシビリティ向上

2. **テスト追加**
   - 新機能の単体テスト
   - E2Eテスト
   - エッジケーステスト

---

## 5. 技術仕様

### 5.1 データ管理
- **ストレージ**: LocalStorage（最大5MB）
- **データ形式**: JSON
- **バックアップ**: エクスポート/インポート機能
- **セキュリティ**: 機密データは保存しない

### 5.2 ブラウザ互換性
- **モダンブラウザ**: Chrome 70+, Firefox 65+, Safari 12+
- **モバイル**: iOS Safari 12+, Chrome Mobile 70+
- **必須機能**: LocalStorage, Clipboard API, URLSearchParams

### 5.3 パフォーマンス要件
- 履歴読み込み: 100ms以内
- 計算実行: 10ms以内
- UI更新: 16ms以内（60fps）

### 5.4 エラーハンドリング
- LocalStorage利用不可時のフォールバック
- ネットワークエラー時のリトライ
- データ破損時のリカバリー

---

## 6. テスト計画

### 6.1 単体テスト
- LocalStorageモジュールのテスト
- 計算ロジックのテスト（全パターン）
- URL生成/解析のテスト

### 6.2 統合テスト
- 履歴保存と表示の連携
- シェア機能のEnd-to-Endテスト
- 複数機能連携のテスト

### 6.3 ユーザビリティテスト
- モバイルデバイスでの操作テスト
- エッジケースのテスト（巨大な数値、特殊文字など）
- アクセシビリティテスト

---

## 7. デリバリーマイルストーン

### Milestone 1: 履歴機能完了（5日目）
- [ ] LocalStorage実装
- [ ] 履歴表示UI
- [ ] 基本的なCRUD操作

### Milestone 2: 計算拡張完了（8日目）
- [ ] 幹事負担パターン実装
- [ ] UI拡張
- [ ] テスト追加

### Milestone 3: シェア機能完了（12日目）
- [ ] クリップボードコピー
- [ ] URL共有
- [ ] SNS連携

### Milestone 4: リリース準備完了（15日目）
- [ ] 全機能の統合テスト
- [ ] ドキュメント更新
- [ ] プロダクションデプロイ

---

## 8. リスクと課題

### 技術的リスク
1. **LocalStorage容量制限** - 大量の履歴データで上限に達する可能性
   - 対策: 自動クリーニング機能、データ圧縮

2. **ブラウザ互換性** - Clipboard APIの対応が限定されている
   - 対策: フォールバック実装、ポリフィル

3. **URL長制限** - パラメータが多すぎるとURLが長くなる
   - 対策: データ圧縮、短縮URLサービス利用

### ユーザビリティリスク
1. **機能過多** - 複雑になりすぎる可能性
   - 対策: シンプルなデフォルト、段階的機能開示

2. **プライバシー** - 履歴データのプライバシー配慮
   - 対策: ローカルのみ保存、明示的な削除オプション

---

*このドキュメントはPhase 2の実装をガイドするための詳細な計画書です。各タスクは具体的な実装ステップに分解されており、順を追って進めることで効率的な開発が可能になります。*